# Implementation Plan

- [ ] 1. 開発基盤（依存関係・スタイル・テスト環境）を整備する
- [ ] 1.1 ライブラリとして必要な依存関係と公開形態を整える
  - React/Styling/Modal primitive/visual effect の導入に必要な依存を追加する
  - 公開 API のエントリポイントから利用できる最小構成を用意する
  - SSR 前提（ブラウザ外）で落ちない前提を確認できる環境を用意する
  - _Requirements: 4.1, 4.2, 4.6, 6.6_
- [ ] 1.2 Tailwind CSS v4 で iOS ライクな見た目・アニメーションの土台を用意する
  - モーダルの開閉に使うトランジション（opacity/transform/blur）を設計方針に沿って用意する
  - `motion-safe` / `motion-reduce` を用いた reduced motion 対応の方針を反映する
  - ベースの可読性（コントラスト、文字サイズ、余白）を確保する
  - _Requirements: 6.1, 6.2, 6.4, 6.5, 6.6_
- [ ] 1.3 Bun のテスト実行基盤を整え、DOM テストが回る状態にする
  - bun test で Testing Library を使えるように preloaded な DOM 環境（happy-dom）を用意する
  - matcher/cleanup などのテスト共通セットアップを用意する
  - テスト失敗時に差分が追える出力が得られることを確認する
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.9_
- [ ] 1.4 `/example` のベースを作り、メタデータとメディアを用意する
  - title/description/icon が設定されたページを用意する
  - 画像または動画のメディアを配置し、表示できる状態にする
  - 「Install」導線（ボタン等）を置けるベース画面を用意する
  - _Requirements: 3.3, 5.2, 5.3, 5.4, 8.1_

- [ ] 2. グローバルモーダルをどこからでも開閉できる状態管理を実装する
- [ ] 2.1 A2HS モーダルの開閉状態を一元管理する仕組みを実装する
  - アプリ全体で一貫した open/close 状態を持てるようにする
  - 開閉の理由（ユーザー操作/プログラム）など拡張の余地を残す
  - モーダル表示状態をアプリ側で観測できる手段を用意する
  - _Requirements: 2.4, 4.3, 4.7, 4.8_
- [ ] 2.2 (P) アプリ内の任意箇所から呼べる “シンプルな Hook” を提供する
  - `open/close/toggle/isOpen` の最小 API を提供する
  - Provider 未セットアップ時でも安全に動作する（no-op もしくは開発時警告）方針を実装に反映する
  - _Requirements: 4.2, 4.3, 4.6, 4.7, 4.8_
- [ ] 2.3 (P) iOS ブラウザ/追加済み判定を行い、表示条件に反映できるようにする
  - iOS ブラウザ判定と standalone 判定を取得できるようにする
  - 判定が不確実な場合でもアプリ側の制御（表示抑制）を優先できるようにする
  - _Requirements: 1.2, 1.3, 1.4_
- [ ] 2.4 「Install」導線からモーダルを開ける連携を example で成立させる
  - クリックで open が呼べ、モーダルが表示されることを確認できるようにする
  - 非 iOS / 追加済みなどの条件で表示抑制できる動作を確認できるようにする
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 3. (P) ホストアプリ情報（favicon/title/description）自動取得を実装する
- [ ] 3.1 ホストページから title と description を抽出できるようにする
  - title 相当の情報を取得し、UI に渡せるようにする
  - description 相当の情報を取得し、UI に渡せるようにする
  - 抽出できない場合にフォールバック可能な値を返す
  - _Requirements: 5.1, 5.2, 5.3, 5.5_
- [ ] 3.2 favicon（icon.png 等を優先）を抽出し、UI へ渡せるようにする
  - favicon 候補を列挙し、優先順位に従って選択できるようにする
  - `icon.png` 等、ホストが設定している画像を優先できる余地を用意する
  - 抽出できない場合にフォールバック可能な値を返す
  - _Requirements: 5.1, 5.4, 5.5_
- [ ] 3.3 SSR 等のブラウザ外環境でも安全に動作するようにする
  - `document` 等が利用できない状況で抽出処理を試みない
  - _Requirements: 4.6, 5.1_
- [ ] 3.4 アプリ側からアプリ情報を上書きできる導線を用意する
  - 自動取得結果を参照しつつ、上書き値を優先できるようにする
  - _Requirements: 5.6, 4.5_

- [ ] 4. モーダル UI（アプリ情報＋手順）を実装し、Portal 経由で表示する
- [ ] 4.1 (P) Portal を用いてグローバルにモーダルを描画できるようにする
  - アプリ内のどこからでも同一のモーダルが表示されるようにする
  - Portal 先がない/制限がある場合でも安全に動作する
  - _Requirements: 2.1, 4.8_
- [ ] 4.2 A2HS モーダルの基本レイアウト（アプリ情報表示）を実装する
  - アイコン/アプリ名/説明を表示する
  - 取得できない項目のフォールバック表示を行う
  - _Requirements: 5.5, 7.1, 7.4_
- [ ] 4.3 A2HS 手順表示（Share→More→Add）と折りたたみを実装する
  - 手順を順序付きで表示する
  - 各手順に短い説明文を付けられるようにする
  - 折りたたみ可能な表示（Hide/Show 等）を提供する
  - _Requirements: 3.1, 3.2, 7.2, 7.3_
- [ ] 4.4 画像/動画メディアを表示し、動画は “再生開始が試行される” ことを担保できるようにする
  - 画像または動画を表示できる枠を用意する
  - 動画の場合、ユーザー操作または表示時に再生開始を試行できる設計にする
  - _Requirements: 3.3, 9.8_
- [ ] 4.5 iOS ライクな開閉アニメーションと reduced motion 対応を反映する
  - 開閉時の自然なトランジション（opacity/transform/blur）を適用する
  - reduced motion の場合はアニメーションを抑制/簡略化する
  - _Requirements: 6.4, 6.5_
- [ ] 4.6 閉じる操作（ボタン/Escape 等）とアクセシビリティを満たす
  - 明示的な close 操作を提供する
  - キーボード操作と支援技術向けの情報を満たす
  - _Requirements: 2.2, 6.3, 7.4_

- [ ] 5. `/example` に統合し、利用者視点の挙動を成立させる
- [ ] 5.1 (P) `/example` で Install 導線→モーダル表示→閉じるの一連フローを完成させる
  - クリックでモーダルが開く
  - 閉じる操作でモーダルが閉じる
  - _Requirements: 1.1, 2.1, 2.2, 8.2_
- [ ] 5.2 (P) `/example` でアプリ情報の自動取得結果が表示されることを確認できるようにする
  - title/description/icon が UI に反映される
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 7.1, 8.2_
- [ ] 5.3 `/example` で基本的なカスタマイズ（文言/メディア差し替え）を示す
  - 手順文言の差し替え例を用意する
  - メディア（画像/動画）の差し替え例を用意する
  - _Requirements: 3.2, 3.3, 4.4, 8.3_

- [ ] 6. lib 側の unit / integration テストを書き、主要ロジックを担保する
- [ ] 6.1 (P) ホスト情報抽出（title/description/icon 優先順位）のユニットテストを追加する
  - icon の優先順位（icon.png 優先など）をテストで担保する
  - 欠損時フォールバックをテストで担保する
  - _Requirements: 5.4, 5.5, 9.2_
- [ ] 6.2 (P) Hook のユニットテストで open/close/toggle と Provider 依存の挙動を担保する
  - Provider セットアップ済みで期待通り状態が変わる
  - Provider 未セットアップ時も安全に動作する
  - _Requirements: 4.7, 4.8, 9.2_
- [ ] 6.3 コンポーネントのユニットテストで表示と操作（close 等）を担保する
  - アプリ情報と手順が表示される
  - close 操作で onOpenChange が呼ばれる
  - _Requirements: 7.1, 7.2, 7.4, 9.1_
- [ ] 6.4 Provider + Portal + Modal の最小結合テストで “開閉が成立する” ことを担保する
  - クリック相当の操作で open→表示→close の一連が成立する
  - _Requirements: 2.1, 2.2, 9.3_

- [ ] 7. `/example` 側の DOM テストでレンダリング結果と挙動を担保する
- [ ] 7.1 (P) クリックでモーダルが開閉することを DOM テストで担保する
  - Install 操作でモーダルが表示される
  - close 操作でモーダルが非表示になる
  - _Requirements: 9.4, 9.5_
- [ ] 7.2 (P) favicon/title/description の取得・表示を DOM テストで担保する
  - icon が表示される（取得できない場合はフォールバック）
  - title/description が表示される
  - _Requirements: 9.6, 9.7_
- [ ] 7.3 動画が “再生開始が試行される” ことを DOM テストで担保する
  - `play()` 呼び出しが観測できる形でテストする
  - _Requirements: 9.8_
